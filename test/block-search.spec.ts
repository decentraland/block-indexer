import { BlockSearch } from "../src/types"
import { createMockBlockRepository } from "./helpers/mocks"
import { createBlockSearch } from "../src"

const range = (start, end) =>
  Array(end - start + 1)
    .fill(0)
    .map((_, idx) => start + idx)

describe("block-indexer", () => {
  const blockSearch = createBlockSearch(
    createMockBlockRepository(10, {
      1: 10,
      2: 20,
      3: 30,
      4: 40,
      5: 50,
      6: 60,
      7: 70,
      8: 80,
      9: 90,
      10: 100,
    })
  )

  it.each(range(0, 9))("works for timestamps before start %p", async (ts) => {
    await expect(blockSearch.findBlockForTimestamp(ts)).resolves.toBeUndefined()
  })

  it.each(range(10, 109))("works for timestamp %p", async (ts) => {
    await expect(blockSearch.findBlockForTimestamp(ts)).resolves.toEqual({
      block: Math.floor(ts / 10),
      timestamp: Math.floor(ts / 10) * 10,
    })
  })

  it.each(range(110, 120))("works for timestamps past current tip %p", async (ts) => {
    await expect(blockSearch.findBlockForTimestamp(ts)).resolves.toEqual({
      block: 10,
      timestamp: 100,
    })
  })

  it.each([
    [1632225210, 13268972, 1632225209],
    [1612524220, 11795934, 1612524214],
    [1612524240, 11795935, 1612524239],
    [1632225210, 13268972, 1632225209],
    [1623203977, 12597525, 1623203966],
    [1623203978, 12597526, 1623203978],
    [1623203990, 12597526, 1623203978],
    [1623204004, 12597527, 1623204003],
    [1623204021, 12597528, 1623204005],
    [1623204030, 12597529, 1623204022],
  ])("find block for timestamp %p", async (entityTs: number, block: number, blockTs: number) => {
    const realBlockSearch: BlockSearch = createBlockSearch(createMockBlockRepository(15597127, realBlocks))

    const currentBlock = await realBlockSearch.findBlockForTimestamp(entityTs)
    expect(currentBlock.block).toBe(block)
    expect(currentBlock.timestamp).toBe(blockTs)
  })
})

const realBlocks = {
  11697846: 1611219738,
  11697847: 1611219762,
  11697848: 1611219810,
  11758772: 1612029859,
  11789235: 1612434455,
  11793042: 1612484852,
  11794946: 1612510402,
  11795898: 1612523687,
  11795927: 1612524129,
  11795934: 1612524214,
  11795935: 1612524239,
  11795936: 1612524247,
  11795938: 1612524278,
  11795942: 1612524359,
  11795957: 1612524501,
  11796017: 1612525336,
  11796136: 1612526683,
  11796374: 1612529697,
  11796850: 1612535886,
  11804466: 1612637440,
  11819698: 1612839471,
  11941551: 1614458294,
  12185256: 1617700479,
  12185257: 1617700483,
  12185258: 1617700488,
  12428961: 1620947066,
  12428962: 1620947089,
  12428963: 1620947095,
  12550813: 1622579830,
  12550814: 1622579851,
  12550815: 1622579854,
  12581276: 1622986774,
  12581277: 1622986780,
  12581278: 1622986784,
  12596507: 1623190431,
  12596508: 1623190460,
  12596509: 1623190477,
  12597459: 1623203190,
  12597460: 1623203228,
  12597461: 1623203244,
  12597518: 1623203870,
  12597519: 1623203875,
  12597520: 1623203890,
  12597525: 1623203966,
  12597526: 1623203978,
  12597527: 1623204003,
  12597528: 1623204005,
  12597529: 1623204022,
  12597530: 1623204033,
  12597531: 1623204040,
  12597533: 1623204066,
  12597534: 1623204067,
  12597535: 1623204069,
  12597548: 1623204235,
  12597549: 1623204260,
  12597550: 1623204264,
  12597578: 1623204623,
  12597579: 1623204626,
  12597580: 1623204630,
  12597697: 1623206197,
  12597698: 1623206202,
  12597699: 1623206208,
  12597935: 1623209400,
  12597936: 1623209414,
  12597937: 1623209415,
  12598411: 1623215890,
  12598412: 1623215898,
  12598413: 1623215909,
  12600315: 1623241436,
  12600316: 1623241440,
  12600317: 1623241463,
  12604123: 1623292676,
  12604124: 1623292683,
  12604125: 1623292690,
  12611739: 1623394202,
  12611740: 1623394237,
  12611741: 1623394279,
  12672666: 1624211945,
  12672667: 1624211950,
  12672668: 1624211951,
  13160076: 1630770405,
  13221002: 1631584548,
  13251465: 1631991912,
  13266696: 1632194996,
  13268600: 1632220220,
  13268838: 1632223480,
  13268957: 1632225042,
  13268971: 1632225205,
  13268972: 1632225209,
  13268973: 1632225212,
  13268974: 1632225225,
  13268978: 1632225258,
  13268986: 1632225322,
  13269016: 1632225833,
  13269076: 1632226719,
  13269552: 1632232785,
  13270504: 1632245496,
  13274312: 1632296763,
  13281928: 1632399273,
  13403781: 1634043775,
  13647487: 1637351130,
  13647488: 1637351171,
  13647489: 1637351237,
  15597127: 1663949159,
  15597128: 1663949171,
  15597129: 1663949183,
  15597130: 1663949195,
  7798564: 1558378252,
  7798565: 1558378271,
}
